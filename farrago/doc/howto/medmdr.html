<html>

<head>
<title>HOWTO:  Use Farrago SQL to Access Metadata Managed by MDR</title>
<link rel="stylesheet" type="text/css" href="../stylesheet.css" />

</head>

<body>

<h1>HOWTO:  Use Farrago SQL to Access Metadata Managed by MDR</h1>

If you are using MDR as a persistent repository, chances are good that at some
point you'll want to expose your repository data as SQL views.  This makes
it possible to use an off-the-shelf query/reporting tool to browse your
repository, generate reports, or just about anything else.

<p>

The Farrago DBMS makes all of this possible via its <a
href="../design/sqlmed.html">SQL/MED extensibility feature</a>.  This
document describes how to make use of the MDR plugin.

<h2>Getting Started with Farrago</h2>

The first step is to get a Farrago build.  See the <a
href="../developerJumpStart.html">developer jump-start page</a> for
details.  For very simple queries (e.g. just a WHERE clause) you don't
need the Fennel C++ components; pure Java can do the job.  But if you
want to do anything serious (e.g. join, ORDER BY), you'll need to
build with Fennel.  The easiest approach is probably to start 
with pure Java (specify --without-fennel to initBuild.sh) and test out
the system with your MDR repository.  Once you have a feel for it and
want to run more complicated queries, you can undertake the additional
steps required for the C++ portion of the build.

<p>

After the initial Farrago build, make sure you're able to run "ant
isql" and execute simple queries via iSQL-Viewer.

<h2>Farrago Talks MDR</h2>

For an example MDR repository, we will use a test btree repository
which is generated by the Farrago build.  This repository contains
just the MOF metametamodel.  The first step is to tell Farrago where
to find this repository.  This is analogous to mounting a device in
Unix in order to make it accessible via the filesystem.  Execute the
following command from iSQL-Viewer:

<pre><code>
create server mof_repository
foreign data wrapper sys_mdr
options(
    "org.netbeans.mdr.persistence.Dir" 'unitsql/ddl/mdr',
    extent_name 'MOF',
    schema_name 'MODEL'
);
</code></pre>

Explanation:

<ul>

<li>
<code>mof_repository</code> is the name we will give the repository in
Farrago.  It will appear as a top-level catalog name.

<li>
<code>sys_mdr</code> is the name of the foreign data wrapper used to
access MDR.  Farrago allows you to define and plug in your own, but this
isn't necessary here because the system already provides one for MDR.

<li>
<code>"org.netbeans.mdr.persistence.Dir"</code> tells MDR the
directory in which to find the btree storage.  This option name has to
be quoted (with double-quotes as an identifier) in order for its case
to be preserved correctly.  Any properties understood by MDR can be
passed in this way (allowing you to choose a storage representation
other than btree, for example).  The path is relative to the
dev/farrago root; if you ran iSQL-Viewer from some other location,
you'll have to modify it accordingly.  Using an absolute path is
usually the best approach.  Note that option values are always single-quoted
(as string literals, not identifiers like option names).

<li>
<code>extent_name</code> tells MDR what extent name to look for
in the repository

<li>
<code>schema_name</code> is bit of a hack.  Normally, in a repository
with a nested package structure, the <code>root_package_name</code>
option would be specified instead, and all child packages of the root
package would appear as schema.  However, the MOF repository has no
nested packages at all, so in such cases the schema_name option should
be specified to make the namespace conform to the standard catalog.schema.table
convention.  Choosing an upper-case name will allow you to avoid quoting
it later.

</ul>

Once the server definition above is created, you can directly query
the repository extent if you know the available class names from the model.
Let's get a list of all of the metaclasses define by MOF:

<pre><code>
select * from mof_repository.model."Class";
</code></pre>

<em>
NOTE: object names from MDR (like <code>"Class"</code>) are case
sensitive and have to be quoted when they aren't upper-case to begin
with.  The reason <code>mof_repository</code> and <code>model</code>
don't have to be quoted is that they were defined by Farrago DDL, not
MDR.
</em>

The results should look something like this:

<p>
  <div>
   <table border="1" cellspacing="0" cellpadding="0">
    <tr>
     <td style="background-color: #426794; color : #FFFFFF;">
      <table border="1" cellspacing="2" cellpadding="2">
       <tr>
        <th>
         Number of Records :: 28
        </th>
       </tr>
       <tr>
        <td style="background-color: #F3F3F3; color : #000000;">
         <table border="1" cellspacing="1" cellpadding="1">
          <tr>
           <th>name&nbsp;</th>
           <th>annotation&nbsp;</th>
           <th>container&nbsp;</th>
           <th>isRoot&nbsp;</th>
           <th>isLeaf&nbsp;</th>
           <th>isAbstract&nbsp;</th>
           <th>visibility&nbsp;</th>
           <th>isSingleton&nbsp;</th>
           <th>mofId&nbsp;</th>
           <th>mofClassName&nbsp;</th>
          </tr>
          <tr>
           <td>Tag&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:000000000000036B&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">Constant&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000364&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>Constraint&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:000000000000035E&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">Parameter&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000352&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>Import&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:000000000000034D&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">Package&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000343&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>AssociationEnd&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:000000000000033E&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">Association&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000331&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>Exception&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000328&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">Operation&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000322&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>BehavioralFeature&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>true&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:000000000000031B&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">Reference&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000319&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>Attribute&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:000000000000030E&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">StructuralFeature&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">true&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:000000000000030A&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>Feature&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>true&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000306&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">AliasType&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000301&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>StructureField&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002FF&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">StructureType&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002FC&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>CollectionType&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002F9&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">EnumerationType&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002F6&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>PrimitiveType&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002F3&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">DataType&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">true&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002F1&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>Class&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002E2&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">Classifier&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">true&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002DB&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>TypedElement&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>true&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002D9&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">GeneralizableElement&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">true&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002D4&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
          <tr>
           <td>Namespace&nbsp;</td>
           <td>&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td>false&nbsp;</td>
           <td>false&nbsp;</td>
           <td>true&nbsp;</td>
           <td>public_vis&nbsp;</td>
           <td>false&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002BD&nbsp;</td>
           <td>Class&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">ModelElement&nbsp;</td>
           <td class="alt">&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">true&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
           <td class="alt">false&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000002A1&nbsp;</td>
           <td class="alt">Class&nbsp;</td>
          </tr>
         </table>
         <hr/>
         <div class="footer"><em>iSQL-Viewer 2.1.5</em></div>
        </td>
       </tr>
      </table>
     </td>
    </tr>
   </table>
  </div>
<p>

Now we know the column names, so we can issue a more meaningful query,
like finding the names of all abstract classes.  Since the
<code>isAbstract</code> column has type BOOLEAN, we can use it
directly in the WHERE clause.

<pre><code>
select "name" from mof_repository.model."Class" where "isAbstract";
</code></pre>

Expected results:

<p>
  <div>
   <table border="1" cellspacing="0" cellpadding="0">
    <tr>
     <td style="background-color: #426794; color : #FFFFFF;">
      <table border="1" cellspacing="2" cellpadding="2">
       <tr>
        <th>
         Number of Records :: 9
        </th>
       </tr>
       <tr>
        <td style="background-color: #F3F3F3; color : #000000;">
         <table border="1" cellspacing="1" cellpadding="1">
          <tr>
           <th>name&nbsp;</th>
          </tr>
          <tr>
           <td>BehavioralFeature&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">StructuralFeature&nbsp;</td>
          </tr>
          <tr>
           <td>Feature&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">DataType&nbsp;</td>
          </tr>
          <tr>
           <td>Classifier&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">TypedElement&nbsp;</td>
          </tr>
          <tr>
           <td>GeneralizableElement&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">Namespace&nbsp;</td>
          </tr>
          <tr>
           <td>ModelElement&nbsp;</td>
          </tr>
         </table>
         <hr/>
         <div class="footer"><em>iSQL-Viewer 2.1.5</em></div>
        </td>
       </tr>
      </table>
     </td>
    </tr>
   </table>
  </div>
<p>

<h2>Result Set Details</h2>

In the first result set above, notice the hexadecimal string ID's for the
<code>container</code> and <code>mofId</code> columns.  These are
MOFID values, which are essentially object identifiers.  The
<code>mofId</code> attribute represents the ID for the object
represented by the row in question (so in the above example, they are
ID's for <code>Class</code> instances).  The association between
<code>Namespace</code> and <code>ModelElement</code> gives rise to the
<code>container</code> column in the <code>Class</code> result set; it's
really a foreign key referencing the <code>mofId</code> column of the
<code>Namespace</code> result set.  MDR takes care of the object-oriented
aspects, so we can query for <code>Package</code> instances, which are
a subset of all <code>Namespace</code> instances:

<pre><code>
select "name","mofId" from mof_repository.model."Package";
</code></pre>

Expected results:

<p>
  <div>
   <table border="1" cellspacing="0" cellpadding="0">
    <tr>
     <td style="background-color: #426794; color : #FFFFFF;">
      <table border="1" cellspacing="2" cellpadding="2">
       <tr>
        <th>
         Number of Records :: 3
        </th>
       </tr>
       <tr>
        <td style="background-color: #F3F3F3; color : #000000;">
         <table border="1" cellspacing="1" cellpadding="1">
          <tr>
           <th>name&nbsp;</th>
           <th>mofId&nbsp;</th>
          </tr>
          <tr>
           <td>CorbaIdlTypes&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:00000000000003A3&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">Model&nbsp;</td>
           <td class="alt">7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000394&nbsp;</td>
          </tr>
          <tr>
           <td>PrimitiveTypes&nbsp;</td>
           <td>7D749D32-73FA-11D8-9D44-AFBC9CB2AA77:0000000000000272&nbsp;</td>
          </tr>
         </table>
         <hr/>
         <div class="footer"><em>iSQL-Viewer 2.1.5</em></div>
        </td>
       </tr>
      </table>
     </td>
    </tr>
   </table>
  </div>
<p>

Notice that the <code>mofId</code> for the row with
<code>name=Model</code> is the same as the <code>container</code> ID
for all of the classes in the first result set.  So this means all MOF
classes are defined in the <code>Model</code> package.  If you have a
Farrago build with Fennel support, you can use a join to navigate the
association; try the query below:

<pre><code>
select 
    n."name" as container_name,
    e."name" as element_name
from
    mof_repository.model."Package" n,
    mof_repository.model."ModelElement" e
where n."mofId" = e."container";
</code></pre>

<p>

Some other result set details:

<ul>

<li>
Besides the <code>mofId</code> column, there is an additional
meta-column <code>mofClassName</code> associated with every table.
When you query a leaf-level class in an object hierarchy, this value
will always be the same (the name of the class you queried).  However,
when you query a non-leaf class (e.g.  <code>select
"name","mofClassName" from mof_repository.model."Namespace"</code>),
the <code>mofClassName</code> column can be used to determine the actual
leaf type of each object returned.

<li>
Datatypes of result columns are inferred automatically using repository
metadata.  All columns show up as nullable (even when the underlying
attribute is mandatory).

<li>
MDR does not supply any precision information for string datatypes, so
Farrago (arbitrarily) chooses VARCHAR(128) for the representation.
This will probably change in the future; for now, a mechanism is
available (described in the next section) for overriding the
default with a different precision.

</ul>

<h2>Local Metadata</h2>

So far, we have been querying the repository directly using our
knowledge of its underlying package structure.  Normally, you will
instead want to capture at least a subset of the repository's metadata
in Farrago's own catalog so that it is available in standard format
(JDBC metadata calls, INFORMATION_SCHEMA, etc.) for use in third-party
query tools such as iSQL-Viewer (or in your own application).  You
will probably also want to define your own data dictionary views on
top of the raw repository tables to transform the metadata into a more
useful format.  There are a number of ways to go about this:

<ol>

<li>
Use the SQL/MED CREATE FOREIGN TABLE command to import metadata for
individual tables into the Farrago catalog, specifying column names
and types explicitly.

<li>
Use the SQL/MED CREATE FOREIGN TABLE command to import metadata for
individual tables into the Farrago catalog, allowing the
system to infer the column names and types.

<li>
Use the SQL/MED IMPORT FOREIGN SCHEMA command to import metadata for
a collection of tables all at once.  This is not yet implemented by Farrago,
so it won't be discussed here.

<li>
Use the CREATE VIEW command to define views directly against the
repository.

<li>
Use the CREATE VIEW command to define views against metadata imported
via one of the first three methods.

</ol>

Here's a CREATE FOREIGN TABLE example:

<pre><code>
create schema mof_schema;

create foreign table mof_schema.exceptions(
    name varchar(20),
    annotation varchar(1),
    container char(54),
    scope varchar(20),
    visibility varchar(20),
    exception_id char(54),
    unused_name varchar(20))
server mof_repository
options (class_name 'Exception');
</code></pre>

Explanation:

<ul>

<li>
We first create a new schema <code>mof_schema</code> under the default
LOCALDB catalog.  This schema will contain our imported metadata.  This
imported metadata will remain available even if the repository becomes
unavailable.

<li>
In this case, the CREATE FOREIGN TABLE command overrides the default
names and datatypes known to the repository.  The names are defined as
case insensitive, so no identifier quotes will be required when
querying this table.  And the datatypes are more reasonable than the
defaults (e.g. we know that the MOFID's for this repository are
fixed-length 54-character strings).

<li>
The table name <code>exceptions</code> is never seen by the repository
at all.  Instead, we explicitly tell the repository the desired
<code>class_name</code> via the options clause at the end.

<li>
If the column names and types had been omitted, they would have been
derived automatically from the repository metadata.  This may be undesirable
when you need control over case-sensitivity or datatypes.

</ul>

Let's query the table via the local metadata:

<pre><code>
select name,visibility
from mof_schema.exceptions;
</code></pre>

<p>
  <div>
   <table border="1" cellspacing="0" cellpadding="0">
    <tr>
     <td style="background-color: #426794; color : #FFFFFF;">
      <table border="1" cellspacing="2" cellpadding="2">
       <tr>
        <th>
         Number of Records :: 2
        </th>
       </tr>
       <tr>
        <td style="background-color: #F3F3F3; color : #000000;">
         <table border="1" cellspacing="1" cellpadding="1">
          <tr>
           <th>NAME&nbsp;</th>
           <th>VISIBILITY&nbsp;</th>
          </tr>
          <tr>
           <td>NameNotResolved&nbsp;</td>
           <td>public_vis&nbsp;</td>
          </tr>
          <tr>
           <td class="alt">NameNotFound&nbsp;</td>
           <td class="alt">public_vis&nbsp;</td>
          </tr>
         </table>
         <hr/>
         <div class="footer"><em>iSQL-Viewer 2.1.5</em></div>
        </td>
       </tr>
      </table>
     </td>
    </tr>
   </table>
  </div>
</p>

If this is the only information desired, we can create a view to capture it:

<pre><code>
create view mof_schema.exception_visibility as
select name,visibility
from mof_schema.exceptions;
</code></pre>

The same view could instead be defined directly against the repository
metadata:

<pre><code>
create view mof_schema.exception_visibility as
select "name" as name,"visibility" as visibility
from mof_repository.model."Exception";
</code></pre>

Note that in this second view definition, the column types would be
based on the repository metadata rather than on the overriding types
specified when the table definition was imported.

<h2>Try This At Home</h2>

If you made it through the above walkthrough, you're ready to give it
a try with your own repository by following similar steps.  There are
a few things you should take into consideration first:

<ul>

<li>
<em>Repository Storage</em>:  If you're not using the default btree storage, 
you'll need to specify different options to the 
<code>create server</code> command.  For example, if you are using
JDBC storage, you might specify something like:

<pre><code>
options(
    "org.netbeans.mdr.storagemodel.StorageFactoryClassName" = 'org.netbeans.mdr.persistence.jdbcimpl.JdbcStorageFactory',
    "MDRStorageProperty.org.netbeans.mdr.persistence.jdbcimpl.driverClassName" = 'org.hsqldb.jdbcDriver',
    "MDRStorageProperty.org.netbeans.mdr.persistence.jdbcimpl.url" = 'jdbc:hsqldb:/home/hsqldb/stored_repos'
)
</code></pre>

<li>
<em>Package Structure</em>:  If your repository model has no nested packages,
you can use the <code>schema_name</code> option as in the MOF example.
Otherwise, you'll need to specify the <code>root_package_name</code>
option instead.  All packages under this root package will appear as
schemas under your repository catalog.  If your package nesting structure
has a depth greater than 2, you'll probably have to choose multiple roots
and issue multiple <code>create server</code> statements accordingly.

<p>

<li>
<em>Concurrent Access</em>: MDR's default btree storage does not allow
more than one process at a time to open the btree files.  This means
Farrago and your application have to take turns accessing the data,
which is probably impractical.  MDR's JDBC storage may provide a
better solution, although it needs improvements in
performance/concurrency control.  And Farrago is not yet
client/server.  So for now, usage of Farrago for MDR querying is
probably limited to proof-of-concept.
</ul>

<a href="mailto:farrago-developers@lists.sf.net">Let us know</a> how
it goes for you.

<h2>TODO</h2>

Show how to use IMPORT FOREIGN SCHEMA once it is working, and also
show metadata browsing via iSQL-Viewer once that is working.

</body>

</html>
