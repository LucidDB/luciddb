<project name="fennel_common_resources" default="warning">

  <!--
// $Id$
// Fennel is a relational database kernel.
// Copyright (C) 2004-2004 Disruptive Tech
//
// This program is free software; you can redistribute it and/or
// modify it under the terms of the GNU Lesser General Public License
// as published by the Free Software Foundation; either version 2.1
// of the License, or (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with this program; if not, write to the Free Software
// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
  -->


  <property name="resource.name" value="FennelResource"/>
  <property name="resource.locales" value="en_US"/>

  <property name="perforce.view" value="//open/fennel/common"/>

  <property
    name="perforce.files"
    value="
${perforce.view}/${resource.name}.h
${perforce.view}/${resource.name}.cpp
${perforce.view}/${resource.name}*.properties
"/>

  <target name="warning">
    <echo>This build script is executed automatically by the fennel/common
Makefile.  Normally, it is not executed by hand, although you may
do so by calling out the generated.resources target excplicitly.</echo>
  </target>

  <target
    name="generate.resources"
    description="Regenerate, if necessary, the Fennel Resource header and implementation and the associated properties files.">

    <!-- We attempt to avoid re-generating files when they don't need it.
         The rationale is to avoid no-op perforce changelist creation and
         submission. (Normally testing is handled by make, but someone might
         run this script directly). This condition is entirely correct: it
         should check all ${resource.name}*.properties files, but the 
         uptodate task doesn't provide a means to do that. -->
    <condition property="subroutine" value="execute.resgen">
      <not>
        <and>
          <uptodate srcfile="${resource.name}.xml" targetfile="${resource.name}.h"/>
          <uptodate srcfile="${resource.name}.xml" targetfile="${resource.name}.cpp"/>
          <uptodate srcfile="${resource.name}.xml" targetfile="${resource.name}.properties"/>
        </and>
      </not>
    </condition>

    <!-- If the property wasn't just set, set it now. -->
    <condition property="subroutine" value="skip.resgen">
      <not>
        <isset property="subroutine"/>
      </not>
    </condition>

    <antcall target="${subroutine}"/>
  </target>

  <path id="resgen.classpath">
    <pathelement location="../../thirdparty/mondrian-resource.jar"/>
    <pathelement location="../../thirdparty/mondrian-xom.jar"/>
  </path>

  <target name="execute.resgen">
    <taskdef name="resgen" classname="mondrian.resource.ResourceGenTask"
      classpathref="resgen.classpath"/>

    <antcall target="checkout.files"/>

    <resgen mode="c++" srcdir="./" locales="${resource.locales}">
      <include name="${resource.name}.xml"/>
    </resgen>
  </target>

  <target name="checkout.files" unless="skip.checkout">
    <echo>Automatically adding files generated by MonRG to the default changelist:</echo>

    <p4edit view="${perforce.files}"/>
  </target>

  <target name="skip.resgen">
    <echo>Skipping resource generation: nothing to do.</echo>
  </target>
</project>
